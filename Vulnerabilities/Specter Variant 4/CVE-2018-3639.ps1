#Requires -RunAsAdministrator
<#
.SYNOPSIS
    Implements protection against CVE-2018-3639 - Speculative Store Bypass (Spectre Variant 4)
.DESCRIPTION
    Addresses Microsoft Windows Security Update Registry Key Configuration Missing (ADV180012) by implementing
    required registry keys based on processor type. Compatible with Windows Server 2008 and above,
    supporting both 32-bit and 64-bit architectures.

.NOTES
    Filename: CV20183639.ps1
    Author: Cline
    Requires: PowerShell 2.0 or higher (for Windows Server 2008 compatibility)
    Supported OS: Windows Server 2008 and above, Windows 7 and above
    Architecture: x86 and x64
    CVE: CVE-2018-3639
    Microsoft Advisory: ADV180012
    Qualys QID: 91462
#>

# Ensure script runs on PowerShell 2.0 and above for maximum compatibility
if ($PSVersionTable.PSVersion.Major -lt 2) {
    Write-Error "This script requires PowerShell 2.0 or higher."
    exit 1
}

Set-StrictMode -Version Latest
$ErrorActionPreference = "Stop"

# Initialize logging with compatibility for older systems
$LogPath = Join-Path $env:TEMP "SpectreMeltdownV4_Protection.log"
$Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
$Global:OSVersion = $null
$Global:Is64Bit = $null

function Write-Log {
    param($Message)
    $LogMessage = "[$Timestamp] $Message"
    try {
        Add-Content -Path $LogPath -Value $LogMessage -ErrorAction Stop
        Write-Host $LogMessage
    }
    catch {
        Write-Host "Failed to write to log file: $_"
        Write-Host $LogMessage
    }
}

function Test-AdminPrivileges {
    try {
        $identity = [Security.Principal.WindowsIdentity]::GetCurrent()
        $principal = New-Object Security.Principal.WindowsPrincipal($identity)
        return $principal.IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)
    }
    catch {
        Write-Log "Error checking admin privileges: $_"
        return $false
    }
}

function Test-SystemCompatibility {
    try {
        # Get OS version information
        $os = Get-WmiObject -Class Win32_OperatingSystem -ErrorAction Stop
        $Global:OSVersion = [Version]$os.Version
        $Global:Is64Bit = [Environment]::Is64BitOperatingSystem

        # Check OS version compatibility
        $minVersion = [Version]"6.0.6001" # Windows Server 2008
        if ($Global:OSVersion -lt $minVersion) {
            throw "This script requires Windows Server 2008 or later. Current version: $($os.Caption)"
        }

        Write-Log "System Information:"
        Write-Log "OS: $($os.Caption)"
        Write-Log "Version: $($Global:OSVersion)"
        Write-Log "Architecture: $(if ($Global:Is64Bit) {'64-bit'} else {'32-bit'})"
        Write-Log "PowerShell Version: $($PSVersionTable.PSVersion)"

        return $true
    }
    catch {
        Write-Log "Error checking system compatibility: $_"
        return $false
    }
}

function Get-ProcessorDetails {
    try {
        # Use older WMI query method for compatibility
        $processor = Get-WmiObject -Class Win32_Processor -ErrorAction Stop
        
        # Some older systems might have multiple processors
        if ($processor -is [array]) {
            $processor = $processor[0]
        }

        # Get processor ID using compatible method
        $processorId = $null
        try {
            $processorId = (Get-ItemProperty "HKLM:\System\CurrentControlSet\Control\Session Manager\Environment" -ErrorAction Stop).PROCESSOR_IDENTIFIER
        }
        catch {
            $processorId = $processor.Name
        }

        Write-Log "Detected Processor: $processorId"
        Write-Log "Manufacturer: $($processor.Manufacturer)"
        Write-Log "Architecture: $(if ($Global:Is64Bit) {'64-bit'} else {'32-bit'})"
        
        return @{
            Type = if ($processor.Manufacturer -match "AMD") { "AMD" } else { "Intel" }
            Details = $processorId
        }
    }
    catch {
        throw "Failed to detect processor details: $_"
    }
}

function Set-SpectreMeltdownProtection {
    try {
        Write-Log "Implementing CVE-2018-3639 mitigation..."
        
        # Using value 72 for FeatureSettingsOverride which is valid for both AMD and Intel
        & reg.exe add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverride /t REG_DWORD /d 72 /f
        Write-Log "Set FeatureSettingsOverride = 72 (valid for both AMD and Intel)"

        & reg.exe add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management" /v FeatureSettingsOverrideMask /t REG_DWORD /d 3 /f
        Write-Log "Set FeatureSettingsOverrideMask = 3"
    }
    catch {
        throw "Failed to set registry keys for CVE-2018-3639 mitigation: $_"
    }
}

function Get-RegistryDWORDValue {
    param (
        [string]$Path,
        [string]$Name
    )
    
    try {
        $output = & reg.exe query $Path /v $Name 2>&1
        if ($LASTEXITCODE -ne 0) {
            Write-Log "Failed to query registry value: $Path\$Name"
            return $null
        }

        # Parse the REG_DWORD value from the output
        $lines = $output -split "`r`n"
        foreach ($line in $lines) {
            if ($line -match "REG_DWORD\s+0x([0-9a-fA-F]+)") {
                return [Convert]::ToInt32($matches[1], 16)
            }
        }
        return $null
    }
    catch {
        Write-Log "Error getting registry value: $_"
        return $null
    }
}

function Test-Protection {
    try {
        $registryPath = "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Memory Management"
        
        # Get registry values using the new helper function
        $override = Get-RegistryDWORDValue -Path $registryPath -Name "FeatureSettingsOverride"
        $mask = Get-RegistryDWORDValue -Path $registryPath -Name "FeatureSettingsOverrideMask"

        Write-Log "Current Settings:"
        Write-Log "FeatureSettingsOverride: $override"
        Write-Log "FeatureSettingsOverrideMask: $mask"

        if ($null -eq $override -or $null -eq $mask) {
            Write-Log "One or more registry values are missing"
            return $false
        }

        # Verify settings
        if ($override -ne 72) {
            Write-Log "FeatureSettingsOverride value is incorrect: $override (should be 72)"
            return $false
        }
        if ($mask -ne 3) {
            Write-Log "FeatureSettingsOverrideMask value is incorrect: $mask (should be 3)"
            return $false
        }

        return $true
    }
    catch {
        Write-Log "Error verifying CVE-2018-3639 protection: $_"
        return $false
    }
}

# Main execution block
try {
    Write-Log "Starting protection script for CVE-2018-3639 (Spectre Variant 4)"
    Write-Log "This script is compatible with Windows Server 2008 and above (32-bit and 64-bit)"

    # Check for admin privileges
    if (-not (Test-AdminPrivileges)) {
        throw "This script requires administrator privileges"
    }

    # Check system compatibility
    if (-not (Test-SystemCompatibility)) {
        throw "System compatibility check failed"
    }

    # Detect processor details (for logging purposes)
    $processorInfo = Get-ProcessorDetails
    Write-Log "Processor Type: $($processorInfo.Type)"
    Write-Log "Processor Details: $($processorInfo.Details)"

    # Apply protection (same settings for both AMD and Intel)
    Set-SpectreMeltdownProtection
    Write-Log "Applied CVE-2018-3639 protection settings"

    # Verify protection
    if (Test-Protection) {
        Write-Log "SUCCESS: CVE-2018-3639 mitigation verified successfully"
        Write-Log "System is now protected against Speculative Store Bypass (Spectre Variant 4)"
    }
    else {
        throw "CVE-2018-3639 protection verification failed"
    }
}
catch {
    Write-Log "ERROR: $_"
    throw $_
}
finally {
    Write-Log "Script execution completed"
    Write-Log "Log file location: $LogPath"
}
